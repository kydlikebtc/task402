# Task402 ç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—

## æµ‹è¯•ç¯å¢ƒå‡†å¤‡

### 1. å¯åŠ¨ Hardhat æœ¬åœ°ç½‘ç»œ

```bash
cd packages/contracts
npx hardhat node
```

ä¿æŒæ­¤ç»ˆç«¯è¿è¡Œ,è®°å½•ä¸‹æ˜¾ç¤ºçš„æµ‹è¯•è´¦æˆ·åœ°å€å’Œç§é’¥ã€‚

### 2. éƒ¨ç½²åˆçº¦

åœ¨æ–°ç»ˆç«¯ä¸­:

```bash
cd packages/contracts
npx hardhat run scripts/deploy-local.js --network localhost
```

éƒ¨ç½²æˆåŠŸå,ä¼šçœ‹åˆ°:
- MockUSDC åœ°å€
- X402Escrow åœ°å€
- TaskRegistry åœ°å€
- å‰ç«¯é…ç½®æ–‡ä»¶å·²æ›´æ–°

### 3. å¯åŠ¨å‰ç«¯

åœ¨æ–°ç»ˆç«¯ä¸­:

```bash
cd app
npm run dev
```

è®¿é—® http://localhost:3000

### 4. é…ç½® MetaMask

1. æ·»åŠ  Hardhat ç½‘ç»œ:
   - ç½‘ç»œåç§°: Hardhat Local
   - RPC URL: http://127.0.0.1:8545
   - Chain ID: 31337
   - è´§å¸ç¬¦å·: ETH

2. å¯¼å…¥æµ‹è¯•è´¦æˆ·:
   - ä» Hardhat node ç»ˆç«¯å¤åˆ¶ç§é’¥
   - å»ºè®®å¯¼å…¥è‡³å°‘ 3 ä¸ªè´¦æˆ·:
     - è´¦æˆ· 1: Creator (å‘å¸ƒä»»åŠ¡)
     - è´¦æˆ· 2: Agent (æ¥å–ä»»åŠ¡)
     - è´¦æˆ· 3: è§‚å¯Ÿè€…

3. ç»™æµ‹è¯•è´¦æˆ·é“¸é€  USDC:

```bash
cd packages/contracts
npx hardhat console --network localhost

# åœ¨ Hardhat æ§åˆ¶å°ä¸­æ‰§è¡Œ:
const USDC = await ethers.getContractFactory("MockUSDC");
const usdc = await USDC.attach("0x5FbDB2315678afecb367f032d93F642f64180aa3");

# ç»™è´¦æˆ· 1 é“¸é€  1000 USDC
await usdc.mint("YOUR_ACCOUNT_1_ADDRESS", ethers.parseUnits("1000", 6));

# ç»™è´¦æˆ· 2 é“¸é€  500 USDC
await usdc.mint("YOUR_ACCOUNT_2_ADDRESS", ethers.parseUnits("500", 6));
```

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: Creator åˆ›å»ºä»»åŠ¡

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ä»»åŠ¡åˆ›å»ºæµç¨‹,USDC è½¬è´¦åˆ° Escrow

**æ­¥éª¤**:

1. åˆ‡æ¢åˆ°è´¦æˆ· 1 (Creator)
2. è®¿é—® http://localhost:3000/create
3. å¡«å†™ä»»åŠ¡è¡¨å•:
   - ä»»åŠ¡æè¿°: "æµ‹è¯•ä»»åŠ¡ - åˆ†æ DeFi æ•°æ®"
   - ä»»åŠ¡åˆ†ç±»: æ•°æ®åˆ†æ
   - å¥–åŠ±é‡‘é¢: 10 USDC
   - æˆªæ­¢æ—¶é—´: é€‰æ‹©æœªæ¥ 7 å¤©

4. ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"
5. MetaMask ä¼šå¼¹å‡ºä¸¤æ¬¡:
   - ç¬¬ä¸€æ¬¡: æˆæƒ TaskRegistry ä½¿ç”¨ USDC
   - ç¬¬äºŒæ¬¡: åˆ›å»ºä»»åŠ¡äº¤æ˜“

6. ç­‰å¾…äº¤æ˜“ç¡®è®¤

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"ä»»åŠ¡åˆ›å»ºæˆåŠŸ"
- âœ… Creator USDC ä½™é¢å‡å°‘ 10 USDC
- âœ… è·³è½¬åˆ°ä»»åŠ¡åˆ—è¡¨å¯ä»¥çœ‹åˆ°æ–°ä»»åŠ¡
- âœ… ä»»åŠ¡çŠ¶æ€: "å¾…æ¥å–"

**éªŒè¯**:
```bash
# åœ¨ Hardhat æ§åˆ¶å°ä¸­éªŒè¯
const TaskRegistry = await ethers.getContractFactory("TaskRegistry");
const registry = await TaskRegistry.attach("0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0");

// è¯»å–æœ€æ–°ä»»åŠ¡ (å‡è®¾æ˜¯ä»»åŠ¡ ID 1)
const task = await registry.tasks(1);
console.log("Task Creator:", task[1]);
console.log("Task Reward:", ethers.formatUnits(task[3], 6));
console.log("Task Status:", task[5]); // 0 = Open

// éªŒè¯ Escrow æ”¶åˆ° USDC
const escrow = await ethers.getContractAt("X402Escrow", "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512");
const balance = await usdc.balanceOf(escrow.target);
console.log("Escrow USDC Balance:", ethers.formatUnits(balance, 6));
```

---

### åœºæ™¯ 2: Agent æ¥å–ä»»åŠ¡

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ Agent è´¨æŠ¼ USDC æ¥å–ä»»åŠ¡

**æ­¥éª¤**:

1. åˆ‡æ¢åˆ°è´¦æˆ· 2 (Agent)
2. è®¿é—®ä»»åŠ¡åˆ—è¡¨: http://localhost:3000/tasks
3. ç‚¹å‡»åˆšåˆ›å»ºçš„ä»»åŠ¡,è¿›å…¥è¯¦æƒ…é¡µ
4. æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å’Œè´¨æŠ¼è¦æ±‚
   - æ˜¾ç¤º: "éœ€è¦è´¨æŠ¼ 2.0 USDC (å¥–åŠ±çš„ 20%)"
   - æ˜¾ç¤º: å½“å‰ USDC ä½™é¢

5. ç‚¹å‡»"æ¥å–ä»»åŠ¡"
6. MetaMask ä¼šå¼¹å‡ºä¸¤æ¬¡:
   - ç¬¬ä¸€æ¬¡: æˆæƒ TaskRegistry ä½¿ç”¨ USDC
   - ç¬¬äºŒæ¬¡: æ¥å–ä»»åŠ¡äº¤æ˜“

7. ç­‰å¾…äº¤æ˜“ç¡®è®¤

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"æ¥å–ä»»åŠ¡æˆåŠŸ"
- âœ… Agent USDC ä½™é¢å‡å°‘ 2 USDC
- âœ… ä»»åŠ¡çŠ¶æ€å˜ä¸º"è¿›è¡Œä¸­"
- âœ… æ˜¾ç¤º Agent åœ°å€
- âœ… å‡ºç°"æäº¤ç»“æœ"è¡¨å•

**éªŒè¯**:
```bash
# åœ¨ Hardhat æ§åˆ¶å°ä¸­éªŒè¯
const task = await registry.tasks(1);
console.log("Task Status:", task[5]); // 1 = Assigned
console.log("Assigned Agent:", task[2]);

// éªŒè¯ Agent è´¨æŠ¼é‡‘é¢
const stakeAmount = await registry.agentStakes(1, "AGENT_ADDRESS");
console.log("Agent Stake:", ethers.formatUnits(stakeAmount, 6)); // 2.0 USDC
```

---

### åœºæ™¯ 3: Agent æäº¤ä»»åŠ¡ç»“æœ

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ Agent æäº¤ç»“æœ

**æ­¥éª¤**:

1. ä¿æŒè´¦æˆ· 2 (Agent) ç™»å½•
2. åœ¨ä»»åŠ¡è¯¦æƒ…é¡µ,æ‰¾åˆ°"æäº¤ç»“æœ"è¡¨å•
3. è¾“å…¥ç»“æœå“ˆå¸Œ:
   ```
   ipfs://QmTest123abc
   ```

4. ç‚¹å‡»"æäº¤ç»“æœ"
5. MetaMask å¼¹å‡ºç¡®è®¤äº¤æ˜“

6. ç­‰å¾…äº¤æ˜“ç¡®è®¤

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"æäº¤ç»“æœæˆåŠŸ"
- âœ… ä»»åŠ¡çŠ¶æ€å˜ä¸º"å¾…éªŒè¯"
- âœ… æ˜¾ç¤ºç»“æœå“ˆå¸Œ
- âœ… æ˜¾ç¤º Verifier éªŒè¯æŒ‰é’® (å¦‚æœæ˜¯ Verifier)

**éªŒè¯**:
```bash
const task = await registry.tasks(1);
console.log("Task Status:", task[5]); // 2 = Submitted
console.log("Result Hash:", task[6]);
```

---

### åœºæ™¯ 4: Verifier éªŒè¯ä»»åŠ¡

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ Verifier ç¡®è®¤ä»»åŠ¡,è§¦å‘èµ„é‡‘ç»“ç®—

**å‰æ**: éœ€è¦ä½¿ç”¨éƒ¨ç½²åˆçº¦æ—¶æŒ‡å®šçš„ Verifier è´¦æˆ·

**æ­¥éª¤**:

1. åˆ‡æ¢åˆ° Verifier è´¦æˆ·
2. è®¿é—®ä»»åŠ¡è¯¦æƒ…é¡µ
3. ç‚¹å‡»"éªŒè¯é€šè¿‡"æŒ‰é’®
4. MetaMask å¼¹å‡ºç¡®è®¤äº¤æ˜“
5. ç­‰å¾…äº¤æ˜“ç¡®è®¤

**é¢„æœŸç»“æœ**:
- âœ… ä»»åŠ¡çŠ¶æ€å˜ä¸º"å·²å®Œæˆ"
- âœ… Agent æ”¶åˆ°å¥–åŠ± (10 * 0.98 = 9.8 USDC) + è´¨æŠ¼é€€è¿˜ (2 USDC) = 11.8 USDC
- âœ… å¹³å°æ”¶åˆ°æ‰‹ç»­è´¹ (10 * 0.015 = 0.15 USDC)
- âœ… Verifier æ”¶åˆ°éªŒè¯è´¹ (10 * 0.005 = 0.05 USDC)

**éªŒè¯**:
```bash
const task = await registry.tasks(1);
console.log("Task Status:", task[5]); // 3 = Completed

// æ£€æŸ¥ Agent ä½™é¢å˜åŒ–
const agentBalance = await usdc.balanceOf("AGENT_ADDRESS");
console.log("Agent Balance:", ethers.formatUnits(agentBalance, 6));
// åº”è¯¥æ˜¯: 500 - 2 + 11.8 = 509.8 USDC

// æ£€æŸ¥å¹³å°ä½™é¢
const platformBalance = await usdc.balanceOf("PLATFORM_ADDRESS");
console.log("Platform Fee:", ethers.formatUnits(platformBalance, 6));
// 0.15 USDC

// æ£€æŸ¥ Verifier ä½™é¢
const verifierBalance = await usdc.balanceOf("VERIFIER_ADDRESS");
console.log("Verifier Fee:", ethers.formatUnits(verifierBalance, 6));
// 0.05 USDC
```

---

### åœºæ™¯ 5: æŸ¥çœ‹æ§åˆ¶é¢æ¿

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç”¨æˆ·æ§åˆ¶é¢æ¿æ˜¾ç¤ºæ­£ç¡®æ•°æ®

**æ­¥éª¤**:

1. åˆ‡æ¢åˆ°è´¦æˆ· 1 (Creator)
2. è®¿é—® http://localhost:3000/dashboard
3. æŸ¥çœ‹ç»Ÿè®¡æ•°æ®:
   - åˆ›å»ºçš„ä»»åŠ¡: 1
   - æ¥å–çš„ä»»åŠ¡: 0
   - æ½œåœ¨æ”¶ç›Š: 0 USDC

4. ç‚¹å‡»"æˆ‘åˆ›å»ºçš„"æ ‡ç­¾
   - æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
   - éªŒè¯ä»»åŠ¡çŠ¶æ€å’Œä¿¡æ¯

5. åˆ‡æ¢åˆ°è´¦æˆ· 2 (Agent)
6. è®¿é—®æ§åˆ¶é¢æ¿
7. æŸ¥çœ‹ç»Ÿè®¡æ•°æ®:
   - åˆ›å»ºçš„ä»»åŠ¡: 0
   - æ¥å–çš„ä»»åŠ¡: 1
   - æ½œåœ¨æ”¶ç›Š: 9.8 USDC (å¦‚æœä»»åŠ¡æœªå®Œæˆ)

8. ç‚¹å‡»"æˆ‘æ¥å–çš„"æ ‡ç­¾
   - æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
   - éªŒè¯ä»»åŠ¡ä¿¡æ¯

**é¢„æœŸç»“æœ**:
- âœ… Creator çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
- âœ… Agent çœ‹åˆ°è‡ªå·±æ¥å–çš„ä»»åŠ¡
- âœ… ç»Ÿè®¡æ•°æ®å‡†ç¡®
- âœ… æ½œåœ¨æ”¶ç›Šè®¡ç®—æ­£ç¡® (æ‰£é™¤ 2% æ‰‹ç»­è´¹)

---

## è¾¹ç•Œæµ‹è¯•

### æµ‹è¯• 1: ä½™é¢ä¸è¶³

1. ä½¿ç”¨ USDC ä½™é¢ä¸è¶³çš„è´¦æˆ·å°è¯•åˆ›å»ºä»»åŠ¡
2. é¢„æœŸ: æ˜¾ç¤ºé”™è¯¯æç¤º "USDC ä½™é¢ä¸è¶³"

### æµ‹è¯• 2: æˆªæ­¢æ—¶é—´è¿‡æœŸ

1. å°è¯•åˆ›å»ºè¿‡å»æ—¶é—´çš„ä»»åŠ¡
2. é¢„æœŸ: æ˜¾ç¤ºé”™è¯¯æç¤º "æˆªæ­¢æ—¶é—´å¿…é¡»åœ¨æœªæ¥"

### æµ‹è¯• 3: é Agent æäº¤ç»“æœ

1. ä½¿ç”¨é Agent è´¦æˆ·å°è¯•æäº¤ç»“æœ
2. é¢„æœŸ: äº¤æ˜“å¤±è´¥æˆ–æŒ‰é’®ç¦ç”¨

### æµ‹è¯• 4: é‡å¤æ¥å–ä»»åŠ¡

1. Agent å°è¯•æ¥å–å·²æ¥å–çš„ä»»åŠ¡
2. é¢„æœŸ: æŒ‰é’®ç¦ç”¨æˆ–äº¤æ˜“å¤±è´¥

---

## æ€§èƒ½æµ‹è¯•

### æµ‹è¯•æ‰¹é‡ä»»åŠ¡è¯»å–

```bash
# åœ¨ Hardhat æ§åˆ¶å°åˆ›å»ºå¤šä¸ªä»»åŠ¡
for (let i = 1; i <= 10; i++) {
  await registry.createTask(
    `Test Task ${i}`,
    ethers.parseUnits("10", 6),
    Math.floor(Date.now() / 1000) + 86400 * 7,
    0
  );
}
```

ç„¶ååœ¨å‰ç«¯:
1. è®¿é—®ä»»åŠ¡åˆ—è¡¨é¡µ
2. æ£€æŸ¥åŠ è½½é€Ÿåº¦
3. é¢„æœŸ: æ‰¹é‡è¯»å–åº”è¯¥å¿«é€Ÿå®Œæˆ (< 2ç§’)

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] åˆ›å»ºä»»åŠ¡æˆåŠŸ
- [ ] æ¥å–ä»»åŠ¡æˆåŠŸ
- [ ] æäº¤ç»“æœæˆåŠŸ
- [ ] éªŒè¯ä»»åŠ¡æˆåŠŸ
- [ ] æ§åˆ¶é¢æ¿æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] ä»»åŠ¡è¯¦æƒ…æ˜¾ç¤ºæ­£ç¡®ä¿¡æ¯

### USDC æµè½¬éªŒè¯
- [ ] Creator USDC è½¬å…¥ Escrow
- [ ] Agent è´¨æŠ¼ USDC è½¬å…¥åˆçº¦
- [ ] å®Œæˆå Agent æ”¶åˆ°å¥–åŠ± + è´¨æŠ¼é€€è¿˜
- [ ] å¹³å°æ”¶åˆ° 1.5% æ‰‹ç»­è´¹
- [ ] Verifier æ”¶åˆ° 0.5% éªŒè¯è´¹

### è¾¹ç•Œæµ‹è¯•
- [ ] ä½™é¢ä¸è¶³é”™è¯¯å¤„ç†
- [ ] æ—¶é—´éªŒè¯
- [ ] æƒé™æ§åˆ¶
- [ ] é‡å¤æ“ä½œé˜²æŠ¤

### UI/UX æµ‹è¯•
- [ ] è¿æ¥é’±åŒ…æµç•…
- [ ] äº¤æ˜“çŠ¶æ€æç¤ºæ¸…æ™°
- [ ] é”™è¯¯æç¤ºå‹å¥½
- [ ] ä½™é¢å®æ—¶æ›´æ–°
- [ ] ä»»åŠ¡çŠ¶æ€å®æ—¶æ›´æ–°

---

## å¸¸è§é—®é¢˜

### Q1: MetaMask æ˜¾ç¤º "insufficient funds for gas"
**A**: ç¡®ä¿æµ‹è¯•è´¦æˆ·æœ‰è¶³å¤Ÿçš„ ETH (Hardhat é»˜è®¤æä¾› 10000 ETH)

### Q2: äº¤æ˜“å¤±è´¥ "execution reverted"
**A**: æ£€æŸ¥:
- USDC ä½™é¢æ˜¯å¦è¶³å¤Ÿ
- æ˜¯å¦å·²æˆæƒåˆçº¦ä½¿ç”¨ USDC
- ä»»åŠ¡çŠ¶æ€æ˜¯å¦æ­£ç¡®

### Q3: å‰ç«¯æ— æ³•è¯»å–ä»»åŠ¡æ•°æ®
**A**: æ£€æŸ¥:
- Hardhat ç½‘ç»œæ˜¯å¦æ­£åœ¨è¿è¡Œ
- åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡® (æŸ¥çœ‹ app/lib/config.json)
- MetaMask è¿æ¥çš„ç½‘ç»œæ˜¯å¦æ­£ç¡®

### Q4: ä»»åŠ¡åˆ—è¡¨ä¸ºç©º
**A**:
- ç¡®è®¤å·²åˆ›å»ºä»»åŠ¡
- æ£€æŸ¥ useTasks hook è¯»å–çš„ä»»åŠ¡ ID èŒƒå›´
- æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

---

## æµ‹è¯•å®Œæˆ

å®Œæˆæ‰€æœ‰æµ‹è¯•å,ä½ åº”è¯¥éªŒè¯:

1. âœ… å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ (åˆ›å»º â†’ æ¥å– â†’ æäº¤ â†’ éªŒè¯ â†’ å®Œæˆ)
2. âœ… USDC æµè½¬æ­£ç¡®æ— è¯¯
3. âœ… æ‰€æœ‰é¡µé¢æ•°æ®æ˜¾ç¤ºæ­£ç¡®
4. âœ… è¾¹ç•Œæƒ…å†µå¤„ç†å¾—å½“
5. âœ… ç”¨æˆ·ä½“éªŒæµç•…

æ­å–œ!Task402 é¡¹ç›®å·²å®Œæˆç«¯åˆ°ç«¯æµ‹è¯•! ğŸ‰
